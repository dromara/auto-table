---
title: å¤šæ•°æ®æº
description: AutoTable å¤šæ•°æ®æºæ”¯æŒä¸é…ç½®
---

# å¤šæ•°æ®æº

AutoTable å†…éƒ¨æ”¯æŒå¤šæ•°æ®æºï¼Œæä¾›äº†è‡ªå®šä¹‰æ•°æ®æºçš„åˆ‡æ¢æ¥å£ã€‚

## å·¥ä½œåŸç†

```mermaid
flowchart TB
    subgraph entities["ğŸ“¦ å®ä½“ç±»"]
        direction LR
        E1["master â†’ User"]
        E2["slave â†’ Order"]
        E3["log â†’ OperationLog"]
    end
    
    HANDLER["ğŸ”„ IDataSourceHandler"]
    
    subgraph datasources["ğŸ’¾ æ•°æ®æº"]
        direction LR
        DS1[("master MySQL")]
        DS2[("slave MySQL")]
        DS3[("log PostgreSQL")]
    end
    
    entities --> HANDLER
    HANDLER --> DS1 & DS2 & DS3
    
    style HANDLER fill:#6366f1,stroke:#4f46e5,color:#fff
    style DS1 fill:#dbeafe,stroke:#3b82f6
    style DS2 fill:#dbeafe,stroke:#3b82f6
    style DS3 fill:#d1fae5,stroke:#10b981
```

## æ ¸å¿ƒæ¥å£

```mermaid
classDiagram
    class IDataSourceHandler {
        <<interface>>
        +getDataSourceName(Class) String
        +useDataSource(String) void
        +clearDataSource(String) void
    }
    
    class SpringBootHandler {
        DynamicDataSource
    }
    
    class PureJavaHandler {
        æ‰‹åŠ¨åˆ‡æ¢DataSource
    }
    
    IDataSourceHandler <|.. SpringBootHandler
    IDataSourceHandler <|.. PureJavaHandler
```

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `getDataSourceName()` | æ ¹æ®å®ä½“ç±»è·å–æ•°æ®æºåç§° |
| `useDataSource()` | åˆ‡æ¢åˆ°æŒ‡å®šæ•°æ®æº |
| `clearDataSource()` | æ¸…é™¤æ•°æ®æºï¼ˆæ¢å¤é»˜è®¤ï¼‰ |

## Spring Boot åº”ç”¨

```mermaid
flowchart LR
    subgraph flow["æ‰§è¡Œæµç¨‹"]
        direction LR
        A["æ‰«æå®ä½“"] --> B["è·å–@DS"]
        B --> C["åˆ‡æ¢æ•°æ®æº"]
        C --> D["æ‰§è¡ŒDDL"]
        D --> E["æ¸…é™¤æ•°æ®æº"]
    end

    style flow fill:#f0f9ff,stroke:#0ea5e9
```

::: warning æé†’
ä¸åŒæ¡†æ¶æ•°æ®æºæ ‡æ³¨æ–¹å¼ä¸åŒï¼Œæ­¤å¤„å‡è®¾ä½¿ç”¨ `@DS(value:String)` æ³¨è§£æ ‡æ³¨ä¸åŒçš„æ•°æ®æº
:::

```java
@Component
public class MyDataSourceHandler implements IDataSourceHandler {

    /**
     * æ ¹æ®å®ä½“ç±»è·å–å¯¹åº”çš„æ•°æ®æºåç§°
     */
    @Override
    public String getDataSourceName(Class<?> clazz) {
        Ds ds = clazz.getAnnotation(Ds.class);
        if (ds != null) {
            return ds.value();
        }
        return DynamicDataSourceContextHolder.getContextKey();
    }

    /**
     * åˆ‡æ¢æ•°æ®æº
     */
    @Override
    public void useDataSource(String dataSourceName) {
        DynamicDataSourceContextHolder.setContextKey(dataSourceName);
    }

    /**
     * æ¸…é™¤æ•°æ®æº
     */
    @Override
    public void clearDataSource(String dataSourceName) {
        DynamicDataSourceContextHolder.removeContextKey();
    }
}
```

### å®ä½“ç¤ºä¾‹

```java
@Data
@AutoTable
@DS("master")  // ä¸»åº“
public class User {
    @PrimaryKey
    private Long id;
    private String username;
}

@Data
@AutoTable
@DS("slave")  // ä»åº“
public class Order {
    @PrimaryKey
    private Long id;
    private Long userId;
    private BigDecimal amount;
}
```

## æ™®é€š Java åº”ç”¨

```mermaid
flowchart TD
    subgraph setup["é…ç½®é˜¶æ®µ"]
        A["å‡†å¤‡mybatis-config"]
        B["åˆå§‹åŒ–DataSource"]
    end
    
    subgraph runtime["è¿è¡Œæ—¶"]
        C["è·å–æ•°æ®æºå"]
        D["è·å–DataSource"]
        E["è®¾ç½®DataSource"]
        F["æ‰§è¡ŒDDL"]
        G["æ¸…é™¤DataSource"]
    end
    
    setup --> runtime
    C --> D --> E --> F --> G

    style setup fill:#f0f9ff,stroke:#0ea5e9
    style runtime fill:#d1fae5,stroke:#10b981
```

```java
public class DynamicDataSourceHandler implements IDataSourceHandler {

    private static final Map<String, String> CONFIG_MAP = new HashMap<>() {{
        put("mysql", "mybatis-config.xml");
        put("pgsql", "mybatis-config-pgsql.xml");
        put("sqlite", "mybatis-config-sqlite.xml");
    }};
    
    private static final Map<String, DataSource> DATA_SOURCE_MAP = new HashMap<>();

    @Override
    public void useDataSource(String dataSourceName) {
        DataSource dataSource = DATA_SOURCE_MAP.computeIfAbsent(
            dataSourceName, 
            this::createDataSource
        );
        // è®¾ç½®æ–°çš„ dataSource
        DataSourceManager.setDataSource(dataSource);
    }

    @Override
    public void clearDataSource(String dataSourceName) {
        DataSourceManager.cleanDataSource();
    }

    @Override
    public String getDataSourceName(Class<?> clazz) {
        Ds annotation = clazz.getAnnotation(Ds.class);
        return annotation != null ? annotation.value() : "mysql";
    }
    
    private DataSource createDataSource(String name) {
        String resource = CONFIG_MAP.get(name);
        try (InputStream is = getClass().getClassLoader()
                .getResourceAsStream(resource)) {
            SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(is);
            return factory.getConfiguration().getEnvironment().getDataSource();
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}
```

::: tip è¯´æ˜
Spring Boot ä¸­ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® `SqlSessionFactory`ï¼Œå› ä¸º Spring ä¿æŒäº†å•å®ä¾‹ï¼Œ
AutoTable çš„ starter åŒ…åœ¨åˆå§‹åŒ–æ—¶å·²è‡ªåŠ¨é…ç½®ã€‚
:::

## ç¬¬ä¸‰æ–¹æ¡†æ¶é›†æˆ

```mermaid
flowchart LR
    subgraph frameworks["ğŸ”§ æ”¯æŒçš„æ¡†æ¶"]
        direction TB
        MP["Mybatis-Plus"]
        MF["Mybatis-Flex"]
        DD["å…¶ä»–æ¡†æ¶"]
    end
    
    AT["AutoTable"] --> frameworks
    frameworks --> DB[("å¤šä¸ªæ•°æ®åº“")]

    style AT fill:#6366f1,stroke:#4f46e5,color:#fff
    style frameworks fill:#f0f9ff,stroke:#0ea5e9
```

å¦‚æœä½¿ç”¨ Mybatis-Plusã€Mybatis-Flex ç­‰æ¡†æ¶ï¼Œå®ƒä»¬éƒ½æœ‰æˆç†Ÿçš„å¤šæ•°æ®æºæ–¹æ¡ˆï¼Œ
AutoTable å¯ä»¥è‰¯å¥½é›†æˆï¼Œå‚è€ƒ [æ¡†æ¶é›†æˆ](/æ¡†æ¶é›†æˆ/)ã€‚

## ä¸‹ä¸€æ­¥

- æŸ¥çœ‹ [Mybatis-Plus é›†æˆ](/æ¡†æ¶é›†æˆ/Mybatis-Plus)
- æŸ¥çœ‹ [Mybatis-Flex é›†æˆ](/æ¡†æ¶é›†æˆ/Mybatis-Flex)
